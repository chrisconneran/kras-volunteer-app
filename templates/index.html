<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>KRAS Kickers Volunteer</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <style>
      body {
        background-color: #f8f9fc;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      }
      .hero {
        background-color: #e9f0ff;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 10px 20px;
        margin-bottom: 6px;
        border-radius: 8px;
        gap: 12px;
      }
      .hero img {
        height: 55px;
        margin-right: 8px;
      }
      .hero-text {
        text-align: left;
      }
      .hero-text h1 {
        font-weight: 700;
        font-size: 1.6rem;
        margin-bottom: 3px;
      }
      .hero-text p {
        font-size: 0.85rem;
        color: #555;
        margin-bottom: 0;
      }

      .scrollable-list {
        max-height: 77vh;
        overflow-y: auto;
        overflow-x: hidden;
        padding-right: 8px;
      }
      .scrollable-list::-webkit-scrollbar {
        width: 8px;
      }
      .scrollable-list::-webkit-scrollbar-thumb {
        background: #bbb;
        border-radius: 4px;
      }
      .scrollable-list::-webkit-scrollbar-track {
        background: #f5f5f5;
        border-radius: 4px;
      }

      .opportunity-card {
        background: white;
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 7px 10px;
        margin-bottom: 8px;
        box-shadow: 0 1px 2px rgba(0,0,0,0.05);
      }
      .opportunity-content {
        display: flex;
        align-items: flex-start;
        gap: 10px;
      }
      .opportunity-card img {
        width: 95px;
        height: 95px;
        object-fit: cover;
        border-radius: 6px;
        border: 1px solid #ccc;
        box-shadow: 0 1px 2px rgba(0,0,0,0.1);
      }
      .apply-btn {
        background-color: #2563eb;
        color: white;
        border: none;
        width: 100%;
        padding: 3px 0;
        border-radius: 6px;
        font-weight: 500;
        font-size: 0.8rem;
      }
      .apply-btn:hover {
        background-color: #1e4ed8;
      }
      .card-title {
        font-weight: 600;
        font-size: 0.95rem;
        margin-bottom: 2px;
      }
      .small-text {
        font-size: 0.8rem;
        color: #555;
        margin-bottom: 2px;
      }
      .form-section {
        background: white;
        padding: 5px 8px;
        border-radius: 8px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        border: 2px solid #2563eb;
      }

      .opportunities-box {
        border: 2px solid #2563eb !important;
        border-radius: 8px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.05);
      }

      .form-section form .mb-2 {
        margin-bottom: 0.25rem !important;
      }
      .form-control-sm {
        font-size: 0.75rem;
        padding: 2px 5px;
        height: 25px;
      }
      textarea.form-control-sm {
        height: 38px;
        resize: none;
      }
      label {
        font-size: 0.75rem;
        margin-bottom: 2px;
      }
      .btn-sm {
        font-size: 0.78rem;
        padding: 3px 6px;
      }
      .section-title {
        font-weight: 600;
        font-size: 0.9rem;
        margin-bottom: 3px;
      }
      .container-custom {
        max-width: 1200px;
        margin: 0 auto;
      }

      /* Preferred contact row */
      .contact-row {
        display: flex;
        align-items: center;
        gap: 4px;
        flex-wrap: nowrap;
      }
      .contact-row label {
        margin-bottom: 0;
        font-weight: 500;
        font-size: 0.72rem;
        white-space: nowrap;
      }
      .contact-row .form-check {
        margin-bottom: 0;
        font-size: 0.7rem;
        display: flex;
        align-items: center;
        gap: 3px;
        white-space: nowrap;
      }
      .contact-row .form-check-input {
        margin-top: 0;
        transform: scale(0.85);
      }
      .contact-row i {
        color: #2563eb;
        font-size: 0.7rem;
      }

      /* Tighter spacing just for the Volunteer Sign-In form */
      .signin-form .mb-2 {
        margin-bottom: 0.15rem !important;
      }

      .signin-form .form-control-sm {
        height: 22px;
        padding-top: 1px;
        padding-bottom: 1px;
      }

      /* Title left, tags right */
      .card-title-row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
        margin-bottom: 2px;
      }
      .tag-box-inline {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        flex-wrap: wrap;
      }

      /* Highlight read-only opportunity fields in the application */
      .readonly-highlight[readonly] {
        color: #2563eb;
        font-weight: 600;
        background-color: #eef3ff;
      }

      /* Current assignments grid under sign-in */
      .volunteer-assignments {
        margin-top: 6px;
        max-height: 160px; /* about 3 rows visible */
        overflow-y: auto;
        border: 1px solid #ddd;
        border-radius: 6px;
        background: white;
        font-size: 0.75rem;
      }
      .volunteer-assignments table {
        width: 100%;
        margin-bottom: 0;
      }
      .volunteer-assignments thead {
        position: sticky;
        top: 0;
        background: #f1f5ff;
        z-index: 1;
      }

      /* Lock visual for sections 2 and 3 */
      .locked {
        pointer-events: none;
        opacity: 0.45;
      }
    </style>
  </head>

  <body class="p-2">
    <div class="container-fluid container-custom">
      <div class="hero">
        <img src="{{ url_for('static', filename='kras_logo.png') }}" alt="KRAS Kickers Logo">
        <div class="hero-text">
          <h1>
            <span style="color:#000;">KRAS Kickers</span>
            <span style="color:#2563eb;">VOLUNTEER</span>
          </h1>
          <p>Make a difference at KRAS Kickers. Volunteer with us to support our mission.</p>
        </div>
      </div>

      <!-- ROW 1: Volunteer Sign-In (full width) -->
      <div class="row mb-2">
        <div class="col-12">
          <div class="form-section">
            <div class="section-title">
              Volunteer Sign-In <span class="text-danger">[Step 1]</span>
            </div>
            <form id="checkinForm" class="signin-form">
              <div class="row g-2 mb-2 align-items-end">
                <div class="col-12 col-lg-3">
                  <label>Email Address</label>
                  <input
                    type="email"
                    name="email"
                    id="check_email"
                    class="form-control form-control-sm"
                    placeholder="you@example.com"
                    required>
                </div>
                <div class="col-12 col-lg-3">
                  <label>First Name</label>
                  <input
                    type="text"
                    name="first_name"
                    id="check_first"
                    class="form-control form-control-sm"
                    placeholder="Jane"
                    required>
                </div>
                <div class="col-12 col-lg-3">
                  <label>Last Name</label>
                  <input
                    type="text"
                    name="last_name"
                    id="check_last"
                    class="form-control form-control-sm"
                    placeholder="Doe"
                    required>
                </div>
                <div class="col-12 col-lg-3">
                  <label>Phone Number</label>
                  <input
                    type="tel"
                    name="phone"
                    id="check_phone"
                    class="form-control form-control-sm phone-mask"
                    placeholder="(xxx)xxx-xxxx"
                    pattern="\(\d{3}\)\d{3}-\d{4}"
                    title="Enter a 10-digit phone number in format (xxx)xxx-xxxx"
                    required>
                </div>
              </div>
              <button type="submit" class="btn btn-outline-primary w-100 btn-sm">
                Check Volunteer Status
              </button>
            </form>
            <div id="checkinMessage" class="mt-1 text-center small"></div>

            <!-- Current volunteer assignments (populated after successful sign-in and verification) -->
            <div id="assignmentsContainer" class="volunteer-assignments d-none">
              <div class="fw-semibold px-2 pt-1">
                Current Volunteer Assignments
              </div>
              <table class="table table-sm mb-0">
                <thead>
                  <tr>
                    <th>Date Submitted</th>
                    <th>Title</th>
                    <th>Time Commitment</th>
                    <th>Duration</th>
                    <th>Frequency</th>
                    <th>Location</th>
                  </tr>
                </thead>
                <tbody id="assignmentsBody">
                  <!-- rows injected by JavaScript -->
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      {% if champion_opps|length > 0 %}
      <div class="mt-2 mb-2">
        <a href="#championAssignmentsContainer" class="btn btn-primary btn-sm">
          Manage My Opportunities
        </a>
      </div>
      {% endif %}
      
      <!-- Champion Assignments Section -->
      <div id="championAssignmentsContainer" class="volunteer-assignments d-none mt-2">
        <div class="fw-semibold px-2 pt-1">
          Opportunities You Champion
        </div>
        <table class="table table-sm mb-0">
          <thead>
            <tr>
              <th>Opportunity</th>
              <th>Manage</th>
            </tr>
          </thead>
          <tbody id="championAssignmentsBody">
            <!-- rows inserted by JavaScript -->
          </tbody>
        </table>
      </div>


      <!-- ROW 2: Volunteer Application (left) + Opportunities (right) -->
      <div id="lockedSections" class="row gx-2 gy-2">
        <!-- Left: Application -->
        <div class="col-md-4">
          <div class="form-section">
            <div class="section-title">
              Volunteer Application <span class="text-danger">[Step 3 - Complete & Submit]</span>
            </div>
            <form id="volunteerForm">
              <div class="mb-2">
                <label>Opportunity Title</label>
                <input type="text" name="title" id="form_title" class="form-control form-control-sm readonly-highlight" readonly>
              </div>
              <div class="row mb-2">
                <div class="col">
                  <label>First Name</label>
                  <input type="text" name="first_name" id="form_first" class="form-control form-control-sm" required>
                </div>
                <div class="col">
                  <label>Last Name</label>
                  <input type="text" name="last_name" id="form_last" class="form-control form-control-sm" required>
                </div>
              </div>
              <div class="row mb-2">
                <div class="col-7">
                  <label>Email Address</label>
                  <input type="email" name="email" id="form_email" class="form-control form-control-sm" required>
                </div>
                <div class="col-5">
                  <label>Phone Number</label>
                  <input
                    type="tel"
                    name="phone"
                    id="form_phone"
                    class="form-control form-control-sm phone-mask"
                    placeholder="(xxx)xxx-xxxx"
                    pattern="\(\d{3}\)\d{3}-\d{4}"
                    title="Enter a 10-digit phone number in format (xxx)xxx-xxxx"
                    required>
                </div>
              </div>
              <div class="mb-2 contact-row">
                <label>Preferred Contact Method:</label>
                <div class="form-check form-check-inline">
                  <input class="form-check-input" type="radio" name="contact" value="Email" checked>
                  <i class="fa-solid fa-envelope"></i>
                  <label class="form-check-label">Email</label>
                </div>
                <div class="form-check form-check-inline">
                  <input class="form-check-input" type="radio" name="contact" value="Text">
                  <i class="fa-solid fa-comment-dots"></i>
                  <label class="form-check-label">Text</label>
                </div>
                <div class="form-check form-check-inline">
                  <input class="form-check-input" type="radio" name="contact" value="Phone">
                  <i class="fa-solid fa-phone"></i>
                  <label class="form-check-label">Phone</label>
                </div>
              </div>
              <div class="mb-2">
                <label>Time Commitment</label>
                <input type="text" name="time" id="form_time" class="form-control form-control-sm readonly-highlight" readonly>
              </div>
              <div class="mb-2">
                <label>Duration</label>
                <input type="text" name="duration" id="form_duration" class="form-control form-control-sm readonly-highlight" readonly>
              </div>
              <div class="mb-2">
                <label>Frequency</label>
                <input type="text" name="frequency" id="form_frequency" class="form-control form-control-sm readonly-highlight" readonly>
              </div>
              <div class="mb-2">
                <label>Location</label>
                <input type="text" name="location" id="form_location" class="form-control form-control-sm readonly-highlight" readonly>
              </div>
              <div class="mb-2">
                <label>Comments / Tell us how you wish to help</label>
                <textarea name="comments" class="form-control form-control-sm" rows="2" placeholder="Share your ideas or availability..."></textarea>
              </div>
              <button class="btn btn-primary w-100 btn-sm">Submit Application</button>
            </form>
          </div>
        </div>

        <!-- Right: Opportunities -->
        <div class="col-md-8">
          <div class="form-section opportunities-box">
            <div class="section-title text-center">
              Volunteer Opportunities <span class="text-danger">[Step 2 - Select Opportunity & Apply]</span>
            </div>
            <div class="scrollable-list">
              {% for opp in opportunities %}
              <div class="opportunity-card">
                <div class="opportunity-content">
                  {% if opp.image %}
                  <img src="{{ url_for('static', filename=opp.image) }}" alt="{{ opp.title }} image">
                  {% endif %}
                  <div class="flex-grow-1">
                    <div class="card-title-row">
                      <div class="card-title mb-0">{{ opp.title }}</div>
                      <div class="tag-box-inline">
                        {% if opp.tags %}
                          {% for tag in opp.tags %}
                            <span class="badge" style="background-color: {{ tag.color }}; color: white;">{{ tag.name }}</span>
                          {% endfor %}
                        {% endif %}
                      </div>
                    </div>

                    <div class="small-text"><b>Time Commitment:</b> {{ opp.time }}</div>
                    <div class="small-text"><b>Duration:</b> {{ opp.duration }}</div>
                    {% if opp.frequency %}
                    <div class="small-text"><b>Frequency:</b> {{ opp.frequency }}</div>
                    {% endif %}
                    <div class="small-text"><b>Location:</b> {{ opp.location }}</div>
                    {% if opp.requirements %}
                    <div class="small-text"><b>Requirements:</b> {{ opp.requirements }}</div>
                    {% endif %}
                    {% if opp.description or opp.desc %}
                    <div class="small-text"><b>Description:</b> {{ opp.description or opp.desc }}</div>
                    {% endif %}
                  </div>
                </div>
                <button 
                  class="apply-btn mt-1" 
                  data-title="{{ opp.title }}" 
                  data-time="{{ opp.time }}" 
                  data-duration="{{ opp.duration }}"
                  data-frequency="{{ opp.frequency }}"
                  data-location="{{ opp.location }}">
                  Apply Now
                </button>
              </div>
              {% endfor %}
            </div>
          </div>
        </div>
      </div>
    </div>



    <script>
      // Manage locking/unlocking of sections 2 and 3 and the application form
      function setApplicationEnabled(enabled) {
        $("#volunteerForm :input").prop("disabled", !enabled);
      }

      function lockAllSections() {
        $("#lockedSections").addClass("locked");
        setApplicationEnabled(false);
      }

      function unlockAllSections() {
        $("#lockedSections").removeClass("locked");
        setApplicationEnabled(true);
      }

      const params = new URLSearchParams(window.location.search);

      // Restore any stored volunteer info (used after verification)
      let storedVolunteer = null;
      try {
        const stored = localStorage.getItem("krasVolunteer");
        if (stored) {
          storedVolunteer = JSON.parse(stored);
        }
      } catch (e) {
        storedVolunteer = null;
      }

      // On first load: keep sections 2–3 visible but locked
      lockAllSections();

      // If returning from email verification (?verified=1), unlock sections and reload live data
      if (params.get("verified") === "1") {
        unlockAllSections();

       // Always prefer stored volunteer email after verification
          let verifiedEmail = (storedVolunteer && storedVolunteer.email)
                                ? storedVolunteer.email.toLowerCase()
                                : $("#check_email").val().trim().toLowerCase();

          // If stored email exists, ensure form shows it
          if (storedVolunteer && storedVolunteer.email) {
              $("#check_email").val(storedVolunteer.email);
          }


          if (verifiedEmail) {
            $.get("/check", { email: verifiedEmail }, function(resp) {

              storedVolunteer = resp;

              // Step 1 identity fields (make read-only)
              $("#check_email").val(resp.email || "").prop("readonly", true);
              $("#check_first").val(resp.first_name || "").prop("readonly", true);
              $("#check_last").val(resp.last_name || "").prop("readonly", true);
              $("#check_phone").val(resp.phone || "").prop("readonly", true);

              // Step 3 fields
              $("#form_first").val(resp.first_name || "");
              $("#form_last").val(resp.last_name || "");
              $("#form_email").val(resp.email || "").prop("readonly", true);
              $("#form_phone").val(resp.phone || "");

              // Assignments table
              const container = $("#assignmentsContainer");
              const body = $("#assignmentsBody");
              body.empty();

              if (resp.assignments && resp.assignments.length > 0) {
                resp.assignments.forEach(function(a) {
                  const row = "<tr>" +
                                "<td>" + (a.submitted_at || "") + "</td>" +
                                "<td>" + (a.title || "") + "</td>" +
                                "<td>" + (a.status || "") + "</td>" +
                                "<td>" + (a.time_commitment || "") + "</td>" +
                                "<td>" + (a.duration || "") + "</td>" +
                                "<td>" + (a.frequency || "") + "</td>" +
                                "<td>" + (a.location || "") + "</td>" +
                              "</tr>";
                  body.append(row);
                });
                container.removeClass("d-none");
              } else {
                container.addClass("d-none");
              }
              /* Champion assignment rendering */
              if (resp.champion_assignments && resp.champion_assignments.length > 0) {
                const champContainer = $("#championAssignmentsContainer");
                const champBody = $("#championAssignmentsBody");
                champBody.empty();

                resp.champion_assignments.forEach(function(c) {
                  const row =
                    "<tr>" +
                      "<td>" + c.title + "</td>" +
                      "<td><a href=\"/applicants/" + c.opp_id + "\" class=\"btn btn-outline-primary btn-sm\">Open</a></td>" +
                    "</tr>";
                  champBody.append(row);
                });

                champContainer.removeClass("d-none");
              } else {
                $("#championAssignmentsContainer").addClass("d-none");
              }
            });
          }
        }
     
      // Populate opportunity form when "Apply Now" is clicked
      $(".apply-btn").on("click", function() {
        // Require verification before selecting an opportunity
        if (params.get("verified") !== "1") {
          alert("Please verify your email (Step 1) before selecting an opportunity.");
          return;
        }

        const title = $(this).data("title");
        const time = $(this).data("time");
        const duration = $(this).data("duration");
        const frequency = $(this).data("frequency") || "";
        const location = $(this).data("location");

        $("#form_title").val(title);
        $("#form_time").val(time);
        $("#form_duration").val(duration);
        $("#form_frequency").val(frequency);
        $("#form_location").val(location);

        $('html, body').animate({ scrollTop: $("#volunteerForm").offset().top - 60 }, 300);
      });

        // Submit volunteer application
      $("#volunteerForm").on("submit", function(e) {
        e.preventDefault();

        // If backend told us to redirect after verification, do it before submitting
        const params = new URLSearchParams(window.location.search);
        if (params.get("verified") !== "1") {
          alert("Please verify your email before submitting the application.");
          return;
        }

        $.ajax({
          url: "/",
          method: "POST",
          data: $(this).serialize(),
          success: function(resp) {
            $("#successText").html(
              "We have received your application to volunteer for: <b>" + resp.title + "</b>.<br><br>" +
              "You will be contacted by a KRAS Kickers volunteer coordinator within 48 hours via your preferred method of contact.<br><br>" +
              "Thank you!"
            );
            new bootstrap.Modal(document.getElementById("successModal")).show();
          },
          error: function(xhr) {
            var data = xhr.responseJSON || {};
            alert(data.error || "Your application could not be submitted.");
          }
        });
      });


      // Volunteer sign-in check
      $("#checkinForm").on("submit", function(e){
        e.preventDefault(); 
        const email = $("#check_email").val().trim();
        const first = $("#check_first").val().trim();
        const last = $("#check_last").val().trim();
        const phone = $("#check_phone").val().trim();

       // Show instant feedback BEFORE waiting for server
      $("#checkinMessage").html("<span class='text-primary'>Checking status... Email has been sent if needed.</span>");

      $.get("/check", { email: email }, function(resp){


          // NEW — required so verified session loads in SAME tab
          if (resp.redirect) {
            window.location = resp.redirect;
            return;
          }

          // Fill sign-in message and pre-fill application form
          if (resp.exists) {
            $("#checkinMessage").html("<span class='text-success fw-semibold'>Welcome back, " + resp.first_name + "!</span>");
            $("#form_first").val(resp.first_name);
            $("#form_last").val(resp.last_name);
            $("#form_email").val(resp.email);
            $("#form_phone").val(resp.phone || phone);
          } else {
            $("#checkinMessage").html("<span class='text-primary'>New volunteer detected. Please check your email to verify, then complete your application.</span>");
            $("#form_first").val(first);
            $("#form_last").val(last);
            $("#form_email").val(email);
            $("#form_phone").val(phone);
          }

          // Save latest data and assignments to localStorage for after verification
          const resolvedFirst = $("#form_first").val().trim();
          const resolvedLast = $("#form_last").val().trim();
          const resolvedEmail = $("#form_email").val().trim();
          const resolvedPhone = $("#form_phone").val().trim();
          const volunteerData = {
            email: resolvedEmail,
            first_name: resolvedFirst,
            last_name: resolvedLast,
            phone: resolvedPhone,
            assignments: resp.assignments || []
          };
          try {
            localStorage.setItem("krasVolunteer", JSON.stringify(volunteerData));
          } catch (e) {
            // ignore storage errors
          }

          // Decide lock/unlock based on whether the backend still wants activation
          if (resp.activation_message) {
            $("#checkinMessage").append("<br>" + resp.activation_message);
            lockAllSections();
            $("#assignmentsContainer").addClass("d-none");
          } else {
            // Email is verified for this session
            unlockAllSections();

            // Make Step 1 identity fields read-only
            $("#check_email").prop("readonly", true);
            $("#check_first").prop("readonly", true);
            $("#check_last").prop("readonly", true);
            $("#check_phone").prop("readonly", true);

            // Keep Step 3 email locked to the verified address
            $("#form_email").prop("readonly", true);
          }
        });
      });





      // Auto-format phone numbers (xxx)xxx-xxxx for any .phone-mask inputs
      const phoneInputs = document.querySelectorAll('.phone-mask');
      phoneInputs.forEach(input => {
        input.addEventListener('input', function (e) {
          let value = e.target.value.replace(/\D/g, '');
          if (value.length > 0) value = '(' + value;
          if (value.length > 4) value = value.slice(0, 4) + ')' + value.slice(4);
          if (value.length > 8) value = value.slice(0, 8) + '-' + value.slice(8);
          if (value.length > 13) value = value.slice(0, 13);
          e.target.value = value;
        });
      });
    </script>

    <div class="modal fade" id="successModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header bg-success text-white">
            <h5 class="modal-title fw-bold">Application Submitted Successfully!</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <p id="successText"></p>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-success" data-bs-dismiss="modal">OK</button>
          </div>
        </div>
      </div>
    </div>

  </body>
</html>
