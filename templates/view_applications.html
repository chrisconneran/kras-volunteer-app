<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>View Applicants – {{ opportunity.title }}</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    body {
      background-color: #f8f9fc;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    .header-box {
      background-color: #e8f0ff;
      border-radius: 10px;
      padding: 15px 20px;
      margin-bottom: 20px;
    }
    .logo {
      height: 55px;
    }
    .opp-image {
      width: 110px;
      height: 110px;
      object-fit: cover;
      border-radius: 8px;
      border: 1px solid #ccc;
      background: #fff;
    }
    #applicantList {
      max-height: 70vh;
      overflow-y: auto;
      border-right: 1px solid #ddd;
    }
    .applicant-item {
      padding: 10px;
      border-bottom: 1px solid #eee;
      cursor: pointer;
    }
    .applicant-item:hover {
      background-color: #eef5ff;
    }
    .applicant-item.selected {
      background-color: #dbeafe !important;
    }
    #detailPanel {
      min-height: 70vh;
    }
    .note-box {
      border: 1px solid #ddd;
      background: #fff;
      border-radius: 6px;
      padding: 8px;
      margin-bottom: 5px;
    }
    .status-badge {
      border-radius: 999px;
      padding: 2px 8px;
      font-size: 0.75rem;
      font-weight: 600;
    }
    .status-pending {
      background-color: #fff3cd;
      color: #856404;
    }
    .status-assigned {
      background-color: #d4edda;
      color: #155724;
    }
    .status-closed_completed {
      background-color: #e2e3e5;
      color: #383d41;
    }
    .status-closed_not_assigned {
      background-color: #f8d7da;
      color: #721c24;
    }
  </style>
</head>

<body class="p-4">

  <div class="container">

    <div class="header-box d-flex justify-content-between align-items-center">
      <div class="d-flex align-items-center gap-3">
        <img src="{{ url_for('static', filename='kras_logo.png') }}" class="logo" alt="KRAS Kickers">
        <div>
          <h3 class="fw-bold text-primary mb-0">View Applicants</h3>
          <div class="text-muted">Review volunteers who applied for this opportunity</div>
        </div>
      </div>

      <a href="{{ back_to_menu_url }}" class="btn btn-outline-primary btn-sm">Back</a>
    </div>

    <div class="card p-3 mb-4">
      <div class="d-flex align-items-start gap-4">

        {% if opportunity.image %}
          <img src="{{ url_for('static', filename=opportunity.image) }}"
               class="opp-image"
               alt="{{ opportunity.title }}">
        {% endif %}

        <div>
          <h5 class="fw-bold">{{ opportunity.title }}</h5>
          <div><b>Time:</b> {{ opportunity.time }}</div>
          <div><b>Duration:</b> {{ opportunity.duration }}</div>
          <div><b>Mode:</b> {{ opportunity.mode }}</div>
          <div><b>Location:</b> {{ opportunity.location }}</div>
          {% if opportunity.requirements %}
            <div><b>Requirements:</b> {{ opportunity.requirements }}</div>
          {% endif %}
          {% if opportunity.desc %}
            <div><b>Description:</b> {{ opportunity.desc }}</div>
          {% endif %}
        </div>

      </div>
    </div>

    <div class="card p-3">
      <div class="row">

        <div class="col-md-4" id="applicantList">
          <h6 class="fw-bold mb-2">Applicants</h6>

          {% for a in applicants %}
          {% set status_class = "status-pending" %}
          {% if a.status == "Assigned" %}
            {% set status_class = "status-assigned" %}
          {% elif a.status == "Closed-Completed" %}
            {% set status_class = "status-closed_completed" %}
          {% elif a.status == "Closed-Not Assigned" %}
            {% set status_class = "status-closed_not_assigned" %}
          {% endif %}
          <div class="applicant-item"
               data-id="{{ a.id }}"
               data-name="{{ a.first_name }} {{ a.last_name }}"
               data-email="{{ a.email }}"
               data-status="{{ a.status }}"
               data-phone="{{ a.phone }}"
               data-contact="{{ a.contact }}"
               data-comments="{{ a.comments }}"
               data-time="{{ a.time }}"
               data-duration="{{ a.duration }}"
               data-location="{{ a.location }}"
               data-history='{{ a.history|tojson }}'
               data-notes='{{ a.notes|tojson }}'>
            <div class="fw-semibold">{{ a.first_name }} {{ a.last_name }}</div>
            <div class="small text-muted">{{ a.email }}</div>
            <div class="small mt-1">
              <span class="badge status-badge {{ status_class }}">{{ a.status }}</span>
            </div>
          </div>
          {% endfor %}

        </div>

        <div class="col-md-8 ps-4" id="detailPanel">
          <div class="text-muted">Select an applicant to view full details.</div>
        </div>

      </div>
    </div>

  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    function mapStatusClass(status) {
      if (status === "Assigned") return "status-assigned";
      if (status === "Closed-Completed") return "status-closed_completed";
      if (status === "Closed-Not Assigned") return "status-closed_not_assigned";
      return "status-pending";
    }

    let currentItem = null;
    let confirmModalInstance = null;

    const items = document.querySelectorAll(".applicant-item");
    const panel = document.getElementById("detailPanel");

    function buildDetailPanel(item) {
      const historyList = JSON.parse(item.dataset.history || "[]");
      const notesList = JSON.parse(item.dataset.notes || "[]");

      let historyHtml = "";
      historyList.forEach(h => {
        historyHtml += `
          <div class="small mb-1">
            <b>${h.timestamp}</b> — ${h.event}
          </div>
        `;
      });

      let notesHtml = "";
      if (notesList.length === 0) {
        notesHtml = `<div class="text-muted small">No notes yet.</div>`;
      } else {
        notesList.forEach(n => {
          notesHtml += `
            <div class="note-box">
              <div>${n.note}</div>
              <div class="small text-muted">${n.timestamp}</div>
            </div>
          `;
        });
      }

      const statusClass = mapStatusClass(item.dataset.status);

      panel.innerHTML = `
        <div class="d-flex align-items-center justify-content-between mb-3">
          <div class="d-flex align-items-center gap-2">
            <h5 class="fw-bold mb-0">${item.dataset.name}</h5>
            <span class="badge status-badge ${statusClass}" id="detailStatusBadge">
              ${item.dataset.status}
            </span>
          </div>
          <div class="text-muted small">
            Selected applicant
          </div>
        </div>

        <div><b>Email:</b> ${item.dataset.email}</div>
        <div><b>Preferred Contact:</b> ${item.dataset.contact}</div>
        <div><b>Phone:</b> ${item.dataset.phone}</div>

        <hr>

        <div><b>Time:</b> ${item.dataset.time}</div>
        <div><b>Duration:</b> ${item.dataset.duration}</div>
        <div><b>Location:</b> ${item.dataset.location}</div>

        <hr>

        <div><b>Comments:</b><br>${item.dataset.comments || "None"}</div>

        <hr>

        <label class="fw-bold mt-3">Status</label>
        <div class="d-flex align-items-center gap-2 mb-3" style="max-width:260px;">
          <select id="statusSelect" class="form-select">
            <option ${item.dataset.status === "Pending" ? "selected" : ""}>Pending</option>
            <option ${item.dataset.status === "Assigned" ? "selected" : ""}>Assigned</option>
            <option ${item.dataset.status === "Closed-Completed" ? "selected" : ""}>Closed-Completed</option>
            <option ${item.dataset.status === "Closed-Not Assigned" ? "selected" : ""}>Closed-Not Assigned</option>
          </select>
          <button class="btn btn-primary" onclick="saveStatus(${item.dataset.id})">
            Update Status
          </button>
        </div>

        <h6 class="fw-bold mt-2">Notes</h6>
        <div id="notesBox" class="mb-2">${notesHtml}</div>

        <textarea id="newNote" class="form-control" placeholder="Add a note..."></textarea>
        <button class="btn btn-success btn-sm mt-2" onclick="saveNote(${item.dataset.id})">Add Note</button>

        <hr>

        <h6 class="fw-bold">History</h6>
        <div id="historyBox">${historyHtml}</div>
      `;
    }

    items.forEach(item => {
      item.addEventListener("click", () => {
        document.querySelectorAll(".applicant-item")
                .forEach(el => el.classList.remove("selected"));

        item.classList.add("selected");
        currentItem = item;
        buildDetailPanel(item);
      });
    });

    function showConfirmModal(message) {
      const bodyEl = document.getElementById("confirmModalBody");
      if (bodyEl) {
        bodyEl.textContent = message;
      }
      if (confirmModalInstance) {
        confirmModalInstance.show();
      } else {
        alert(message);
      }
    }

    function saveStatus(id) {
      const selectEl = document.getElementById("statusSelect");
      if (!selectEl) {
        showConfirmModal("Cannot find status selector.");
        return;
      }
      const newStatus = selectEl.value;

      fetch("/update_status/" + id, {
        method: "POST",
        headers: {
          "Content-Type": "application/x-www-form-urlencoded;charset=UTF-8"
        },
        body: new URLSearchParams({ status: newStatus })
      })
      .then(async r => {
        const data = await r.json().catch(() => ({}));
        if (!r.ok || data.error) {
          showConfirmModal(data.error || "Unable to update status.");
          return;
        }

        if (currentItem) {
          currentItem.dataset.status = newStatus;
          const listBadge = currentItem.querySelector(".status-badge");
          if (listBadge) {
            listBadge.textContent = newStatus;
            listBadge.className = "badge status-badge " + mapStatusClass(newStatus);
          }
        }

        const detailBadge = document.getElementById("detailStatusBadge");
        if (detailBadge) {
          detailBadge.textContent = newStatus;
          detailBadge.className = "badge status-badge " + mapStatusClass(newStatus);
        }

        const historyBox = document.getElementById("historyBox");
        if (historyBox) {
          const now = new Date();
          const ts = now.toISOString().slice(0, 16).replace("T", " ");
          const div = document.createElement("div");
          div.className = "small mb-1";
          div.innerHTML = "<b>" + ts + "</b> — Status updated to " + newStatus;
          historyBox.prepend(div);
        }

        showConfirmModal("Status updated.");
      })
      .catch(() => {
        showConfirmModal("Unexpected error updating status.");
      });
    }

    function saveNote(id) {
      const textArea = document.getElementById("newNote");
      const text = textArea ? textArea.value.trim() : "";
      if (!text) {
        showConfirmModal("Please enter a note first.");
        return;
      }

      fetch("/add_note/" + id, {
        method: "POST",
        headers: {
          "Content-Type": "application/x-www-form-urlencoded;charset=UTF-8"
        },
        body: new URLSearchParams({ note: text })
      })
      .then(async r => {
        const data = await r.json().catch(() => ({}));
        if (!r.ok || data.error) {
          showConfirmModal(data.error || "Unable to add note.");
          return;
        }

        const notesBox = document.getElementById("notesBox");
        if (notesBox) {
          const now = new Date();
          const ts = now.toISOString().slice(0, 16).replace("T", " ");
          const wrapper = document.createElement("div");
          wrapper.className = "note-box";
          wrapper.innerHTML = "<div>" + text + "</div>" +
                              "<div class=\"small text-muted\">" + ts + "</div>";
          notesBox.prepend(wrapper);
        }

        if (textArea) {
          textArea.value = "";
        }

        showConfirmModal("Note added.");
      })
      .catch(() => {
        showConfirmModal("Unexpected error adding note.");
      });
    }

    document.addEventListener("DOMContentLoaded", function() {
      const modalEl = document.getElementById("confirmModal");
      if (modalEl && window.bootstrap) {
        confirmModalInstance = new bootstrap.Modal(modalEl);
      }

      const firstItem = document.querySelector(".applicant-item");
      if (firstItem) {
        firstItem.click();
      }
    });
  </script>

  <div class="modal fade" id="confirmModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Update Saved</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="confirmModalBody"></div>
        <div class="modal-footer">
          <button type="button" class="btn btn-primary" data-bs-dismiss="modal">OK</button>
        </div>
      </div>
    </div>
  </div>

</body>
</html>
