<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>View Applicants – {{ opportunity.title }}</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    body {
      background-color: #f8f9fc;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    .header-box {
      background-color: #e8f0ff;
      border-radius: 10px;
      padding: 15px 20px;
      margin-bottom: 20px;
    }
    .logo {
      height: 55px;
    }
    .opp-image {
      width: 110px;
      height: 110px;
      object-fit: cover;
      border-radius: 8px;
      border: 1px solid #ccc;
      background: #fff;
    }
    #applicantList {
      max-height: 70vh;
      overflow-y: auto;
      border-right: 1px solid #ddd;
    }
    .applicant-item {
      padding: 10px;
      border-bottom: 1px solid #eee;
      cursor: pointer;
    }
    .applicant-item:hover {
      background-color: #eef5ff;
    }
    .selected {
      background-color: #dbeafe !important;
    }
    #detailPanel {
      min-height: 70vh;
    }
    .note-box {
      border: 1px solid #ddd;
      background: #fff;
      border-radius: 6px;
      padding: 8px;
      margin-bottom: 5px;
    }
  </style>
</head>

<body class="p-4">

  <div class="container">

    <div class="header-box d-flex justify-content-between align-items-center">
      <div class="d-flex align-items-center gap-3">
        <img src="{{ url_for('static', filename='kras_logo.png') }}" class="logo">
        <div>
          <h3 class="fw-bold text-primary mb-0">View Applicants</h3>
          <div class="text-muted">Review volunteers who applied for this opportunity</div>
        </div>
      </div>

      <a href="{{ back_to_menu_url }}" class="btn btn-outline-primary btn-sm">Back</a>
    </div>

    <div class="card p-3 mb-4">
      <div class="d-flex align-items-start gap-4">

        {% if opportunity.image %}
          <img src="{{ url_for('static', filename=opportunity.image) }}"
               class="opp-image"
               alt="{{ opportunity.title }}">
        {% endif %}

        <div>
          <h5 class="fw-bold">{{ opportunity.title }}</h5>
          <div><b>Time:</b> {{ opportunity.time }}</div>
          <div><b>Duration:</b> {{ opportunity.duration }}</div>
          <div><b>Mode:</b> {{ opportunity.mode }}</div>
          <div><b>Location:</b> {{ opportunity.location }}</div>
          {% if opportunity.requirements %}
            <div><b>Requirements:</b> {{ opportunity.requirements }}</div>
          {% endif %}
          {% if opportunity.desc %}
            <div><b>Description:</b> {{ opportunity.desc }}</div>
          {% endif %}
        </div>

      </div>
    </div>

    <div class="card p-3">
      <div class="row">

        <div class="col-md-4" id="applicantList">
          <h6 class="fw-bold mb-2">Applicants</h6>

          {% for a in applicants %}
          <div class="applicant-item"
               data-id="{{ a.id }}"
               data-name="{{ a.first_name }} {{ a.last_name }}"
               data-email="{{ a.email }}"
               data-status="{{ a.status }}"
               data-phone="{{ a.phone }}"
               data-contact="{{ a.contact }}"
               data-comments="{{ a.comments }}"
               data-time="{{ a.time }}"
               data-duration="{{ a.duration }}"
               data-location="{{ a.location }}"
               data-history='{{ a.history|tojson }}'
               data-notes='{{ a.notes|tojson }}'>
            <div class="fw-semibold">{{ a.first_name }} {{ a.last_name }}</div>
            <div class="small text-muted">{{ a.email }}</div>
            <div class="small"><b>Status:</b> {{ a.status }}</div>
          </div>
          {% endfor %}

        </div>

        <div class="col-md-8 ps-4" id="detailPanel">
          <div class="text-muted">Select an applicant to view full details.</div>
        </div>

      </div>
    </div>

  </div>

<script>
  const items = document.querySelectorAll('.applicant-item');
  const panel = document.getElementById('detailPanel');

  items.forEach(item => {
    item.addEventListener('click', () => {

      document.querySelectorAll('.applicant-item')
              .forEach(el => el.classList.remove('selected'));

      item.classList.add('selected');

      const historyList = JSON.parse(item.dataset.history || "[]");
      const notesList = JSON.parse(item.dataset.notes || "[]");

      let historyHtml = "";
      historyList.forEach(h => {
        historyHtml += `
          <div class="small mb-1">
            <b>${h.timestamp}</b> — ${h.event}
          </div>
        `;
      });

      let notesHtml = "";
      if (notesList.length === 0) {
        notesHtml = `<div class="text-muted small">No notes yet.</div>`;
      } else {
        notesList.forEach(n => {
          notesHtml += `
            <div class="note-box">
              <div>${n.note}</div>
              <div class="small text-muted">${n.timestamp}</div>
            </div>
          `;
        });
      }

      panel.innerHTML = `
        <h5 class="fw-bold mb-3">${item.dataset.name}</h5>

        <div><b>Email:</b> ${item.dataset.email}</div>
        <div><b>Preferred Contact:</b> ${item.dataset.contact}</div>
        <div><b>Phone:</b> ${item.dataset.phone}</div>

        <hr>

        <div><b>Time:</b> ${item.dataset.time}</div>
        <div><b>Duration:</b> ${item.dataset.duration}</div>
        <div><b>Location:</b> ${item.dataset.location}</div>

        <hr>

        <div><b>Comments:</b><br>${item.dataset.comments || 'None'}</div>

        <hr>

        <label class="fw-bold mt-3">Status</label>
        <select id="statusSelect" class="form-select" style="max-width:220px">
          <option ${item.dataset.status === 'Pending' ? 'selected' : ''}>Pending</option>
          <option ${item.dataset.status === 'Assigned' ? 'selected' : ''}>Assigned</option>
          <option ${item.dataset.status === 'Closed-Completed' ? 'selected' : ''}>Closed-Completed</option>
          <option ${item.dataset.status === 'Closed-Not Assigned' ? 'selected' : ''}>Closed-Not Assigned</option>
        </select>

        <button class="btn btn-primary mt-2" onclick="saveStatus(${item.dataset.id})">
          Update Status
        </button>

        <hr>

        <h6 class="fw-bold mt-3">Notes</h6>
        <div id="notesBox">${notesHtml}</div>

        <textarea id="newNote" class="form-control mt-2" placeholder="Add a note..."></textarea>
        <button class="btn btn-success btn-sm mt-2" onclick="saveNote(${item.dataset.id})">Add Note</button>

        <hr>

        <h6 class="fw-bold">History</h6>
        <div id="historyBox">${historyHtml}</div>
      `;
    });
  });

  function saveStatus(id) {
    const newStatus = document.getElementById('statusSelect').value;

    fetch('/update_status/' + id, {
      method: 'POST',
      body: new URLSearchParams({ status: newStatus })
    })
    .then(r => r.json())
    .then(() => {
      alert('Status updated!');
      location.reload();
    });
  }

  function saveNote(id) {
    const text = document.getElementById('newNote').value.trim();
    if (!text) {
      alert('Please enter a note first.');
      return;
    }

    fetch('/add_note/' + id, {
      method: 'POST',
      body: new URLSearchParams({ note: text })
    })
    .then(r => r.json())
    .then(() => {
      alert('Note added!');
      location.reload();
    });
  }
</script>

</body>
</html>
